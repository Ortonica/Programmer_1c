
&ИзменениеИКонтроль("УстановитьБлокировкуРегистров")
Процедура РСК_УстановитьБлокировкуРегистров(ДокументОбъект, МенеджерВременныхТаблиц)
	
	#Вставка     
	Если ДокументОбъект.ДополнительныеСвойства.Свойство("НеИспользоватьБлокировкуРегистров") Тогда   
		Возврат;
	КонецЕсли;
	#КонецВставки
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОтборыОстатков.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
	|ИЗ
	|	ВтОтборыОстатковОрганизаций КАК ОтборыОстатков
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОтборыОстатков.ВидЗапасов КАК ВидЗапасов
	|ИЗ
	|	ВтОтборыОстатковОрганизаций КАК ОтборыОстатков
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
	|		ПО ОтборыОстатков.ВидЗапасов = ВидыЗапасов.Ссылка
	|ГДЕ
	|	(ВидыЗапасов.ЭтоДубль
	|			ИЛИ ВидыЗапасов.Устаревший)";
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	РезультатЗапросаОтборОстатков			= РезультатЗапроса[0];
	РезультатЗапросаУстаревшиеВидыЗапасов	= РезультатЗапроса[1];
	
	ОбъектДвижения = ?(ТипЗнч(ДокументОбъект) = Тип("ДокументОбъект.Сторно"),
						ДокументОбъект.СторнируемыйДокумент.ПолучитьОбъект(),
						ДокументОбъект);
	
	Блокировка = Новый БлокировкаДанных;
	
	Если ЕстьДвижениеВКоллекции(ОбъектДвижения, "ТоварыОрганизаций") Тогда
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыОрганизаций");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.ИсточникДанных = РезультатЗапросаОтборОстатков;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("АналитикаУчетаНоменклатуры", "АналитикаУчетаНоменклатуры");
		
		Если ЕстьДвижениеВКоллекции(ДокументОбъект,"РезервыТоваровОрганизаций") = Неопределено Тогда
			ТекстИсключения = НСтр("ru = 'Ошибка в описании движений документа: документ является регистратором %Регистр1% и не является регистратором %Регистр2%.';
									|en = 'An error occurred in the document record description: the document is the %Регистр1% recorder and is not the %Регистр2% recorder.'");
			ТекстИсключения = СтрЗаменить(ТекстИсключения, "%Регистр2%", "РезервыТоваровОрганизаций");
			ТекстИсключения = СтрЗаменить(ТекстИсключения, "%Регистр1%", "ТоварыОрганизаций");
			
			ВызватьИсключение ТекстИсключения;
		КонецЕсли;
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.РезервыТоваровОрганизаций");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.ИсточникДанных = РезультатЗапросаОтборОстатков;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("АналитикаУчетаНоменклатуры", "АналитикаУчетаНоменклатуры");
		
		Если Не РезультатЗапросаУстаревшиеВидыЗапасов.Пустой() Тогда
			ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.УстаревшиеВидыЗапасовСОстатками");
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			ЭлементБлокировки.ИсточникДанных = РезультатЗапросаУстаревшиеВидыЗапасов;
			ЭлементБлокировки.ИспользоватьИзИсточникаДанных("ВидЗапасов", "ВидЗапасов");
		КонецЕсли;
		
	КонецЕсли;

	Если ЕстьДвижениеВКоллекции(ОбъектДвижения, "ТоварыКОформлениюОтчетовКомитенту") Тогда
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыКОформлениюОтчетовКомитенту");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.ИсточникДанных = РезультатЗапросаОтборОстатков;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("АналитикаУчетаНоменклатуры", "АналитикаУчетаНоменклатуры");
		
	КонецЕсли;
	
	//++ НЕ УТ

	//++ Устарело_Переработка24
	Если ЕстьДвижениеВКоллекции(ОбъектДвижения, "ТоварыПереданныеПереработчику") Тогда
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыПереданныеПереработчику");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.ИсточникДанных = РезультатЗапросаОтборОстатков;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("АналитикаУчетаНоменклатуры", "АналитикаУчетаНоменклатуры");
		
	КонецЕсли;
	//-- Устарело_Переработка24

	//-- НЕ УТ
	
	Если ЕстьДвижениеВКоллекции(ОбъектДвижения, "ТоварыПереданныеНаКомиссию") Тогда
		
		ЗапросПоКомиссии = Новый Запрос;
		ЗапросПоКомиссии.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОтборыОстатков.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ИЗ
		|	ВтОтборыОстатковОрганизаций КАК ОтборыОстатков
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	АналитикаКомиссионера.КлючАналитики КАК АналитикаУчетаНоменклатуры
		|ИЗ
		|	ВтОтборыОстатковОрганизаций КАК ОтборыОстатков
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
		|		ПО Ключи.Ссылка = ОтборыОстатков.АналитикаУчетаНоменклатуры
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаКомиссионера
		|		ПО АналитикаКомиссионера.Номенклатура = Ключи.Номенклатура
		|			И АналитикаКомиссионера.Характеристика = Ключи.Характеристика
		|			И АналитикаКомиссионера.Серия = Ключи.Серия
		|			И АналитикаКомиссионера.МестоХранения = &Партнер
		|			И АналитикаКомиссионера.Назначение = Ключи.Назначение
		//++ НЕ УТ
		|			И АналитикаКомиссионера.СтатьяКалькуляции = Ключи.СтатьяКалькуляции
		//-- НЕ УТ
		|";
		
		ЗапросПоКомиссии.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		
		Если ТипЗнч(ОбъектДвижения) = Тип("ДокументОбъект.ОтчетПоКомиссииМеждуОрганизациями") Тогда
			ЗапросПоКомиссии.УстановитьПараметр("Партнер", ОбъектДвижения.Комиссионер);
		Иначе
			ЗапросПоКомиссии.УстановитьПараметр("Партнер", ОбъектДвижения.Партнер);
		КонецЕсли;
		
		РезультатЗапросаПоКомиссии = ЗапросПоКомиссии.Выполнить();
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыПереданныеНаКомиссию");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		ЭлементБлокировки.ИсточникДанных = РезультатЗапросаПоКомиссии;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("АналитикаУчетаНоменклатуры", "АналитикаУчетаНоменклатуры");
		
	КонецЕсли;
	
	Блокировка.Заблокировать();
	
КонецПроцедуры

&ИзменениеИКонтроль("ПроверкаОтрицательныхОстатковТоваровОрганизаций")
Процедура РСК_ПроверкаОтрицательныхОстатковТоваровОрганизаций(ПараметрыПроверки)

	СписокПолей = Новый СписокЗначений;
	СписокПолей.Добавить("Организация",					НСтр("ru = 'Организация';
	|en = 'Company'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("АналитикаУчетаНоменклатуры",	НСтр("ru = 'Аналитика номенклатуры';
	|en = 'Item dimension'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("ВидЗапасов",					НСтр("ru = 'Вид запасов';
	|en = 'Inventory owner attributes'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("НомерГТД",					НСтр("ru = 'Номер ГТД';
	|en = 'CCD number'", ОбщегоНазначения.КодОсновногоЯзыка()));
	СписокПолей.Добавить("Количество",					НСтр("ru = 'Количество';
	|en = 'Quantity'", ОбщегоНазначения.КодОсновногоЯзыка()));

	ПараметрыРегистрации = ЗакрытиеМесяцаСервер.ИнициализироватьПараметрыРегистрацииПроблемПроверки(
	"ОтрицательныеОстатки",
	НСтр("ru = 'Обнаружены отрицательные остатки товаров организации ""%1"" на конец периода %2';
	|en = 'Negative stock balance of the ""%1"" company goods is detected as of the end of the %2 period'", ОбщегоНазначения.КодОсновногоЯзыка()),
	СписокПолей);

	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("НеконтролируемыеТипыЗапасов",             Перечисления.ТипыЗапасов.НеконтролируемыеПоТоварамОрганизацииТипыЗапасов());
	ДополнительныеПараметры.Вставить("ОперацииРаздельногоОформленияЗакупок",    ЗакупкиСервер.ХозяйственныеОперацииРаздельнойЗакупкиБезОтборов());
	ДополнительныеПараметры.Вставить("ИспользуетсяРаздельноеОформлениеЗакупок", ПолучитьФункциональнуюОпцию("ИспользоватьТоварыВПутиОтПоставщиков")  
	ИЛИ ПолучитьФункциональнуюОпцию("ИспользоватьНеотфактурованныеПоставки"));
	#Вставка
	ДополнительныеПараметры.Вставить("ТипЗапасовТоварыВПути", Перечисления.ТипыЗапасов.СобственныйТоварВПути);
	ДополнительныеПараметры.Вставить("СкладЗаказа", реа_ОбщийСерверПовтИсп.ПолучитьПредопределенноеЗначение("РС_Склад", "Склад заказа"));
	#КонецВставки

	ЗакрытиеМесяцаСервер.ЗарегистрироватьПроблемыВыполненияПроверки(ПараметрыПроверки,
	ПараметрыРегистрации,
	ЗапросОтрицательныеОстаткиТоваровОрганизаций(),
	ДополнительныеПараметры);

КонецПроцедуры

&ИзменениеИКонтроль("ЗапросОтрицательныеОстаткиТоваровОрганизаций")
Функция РСК_ЗапросОтрицательныеОстаткиТоваровОрганизаций()

	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ВидЗапасов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ВТРазрешенныеВидыЗапасов
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидЗапасов
	|ГДЕ
	|	НЕ ВидЗапасов.ТипЗапасов В (&НеконтролируемыеТипыЗапасов)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	#Вставка
	|ВЫБРАТЬ
	|	ВидЗапасов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ВТВидыЗапасовВПути
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидЗапасов
	|ГДЕ
	|	ВидЗапасов.ТипЗапасов = &ТипЗапасовТоварыВПути
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	#КонецВставки
	|ВЫБРАТЬ
	|	ТоварыОрганизаций.Организация КАК Организация,
	|	ТоварыОрганизаций.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ТоварыОрганизаций.ВидЗапасов КАК ВидЗапасов,
	|	ТоварыОрганизаций.АналитикаУчетаНоменклатуры.Номенклатура.ВестиУчетПоГТД КАК ВестиУчетПоГТД,
	|	ТоварыОрганизаций.НомерГТД КАК НомерГТД,
	|	&КонецПериода КАК Период,
	|	ТоварыОрганизаций.КоличествоОстаток КАК КоличествоОстаток,
	|	ТоварыОрганизаций.КОформлениюСписанияОстаток КАК КОформлениюСписанияОстаток
	|ПОМЕСТИТЬ ВТОстаткиТекущийПериодВсе
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций.Остатки(
	|			&ГраницаКонецПериода,
	|			Организация В (&МассивОрганизаций)
	|				И ВидЗапасов В
	|					(ВЫБРАТЬ
	|						ВидЗапасов.Ссылка
	|					ИЗ
	|						ВТРазрешенныеВидыЗапасов КАК ВидЗапасов)) КАК ТоварыОрганизаций
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Резервы.Организация,
	|	Резервы.АналитикаУчетаНоменклатуры,
	|	Резервы.ВидЗапасов,
	|	Резервы.АналитикаУчетаНоменклатуры.Номенклатура.ВестиУчетПоГТД,
	|	Резервы.НомерГТД,
	|	&КонецПериода КАК Период,
	|	Резервы.КоличествоОстаток,
	|	0
	|ИЗ
	|	РегистрНакопления.РезервыТоваровОрганизаций.Остатки(
	|			&ГраницаКонецПериода,
	|			Организация В (&МассивОрганизаций)
	|				И ВидЗапасов В
	|					(ВЫБРАТЬ
	|						ВидЗапасов.Ссылка
	|					ИЗ
	|						ВТРазрешенныеВидыЗапасов КАК ВидЗапасов)) КАК Резервы
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВестиУчетПоГТД,
	|	НомерГТД,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов 
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыОрганизаций.Организация КАК Организация,
	|	ТоварыОрганизаций.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ТоварыОрганизаций.ВидЗапасов КАК ВидЗапасов,
	|	ТоварыОрганизаций.АналитикаУчетаНоменклатуры.Номенклатура.ВестиУчетПоГТД КАК ВестиУчетПоГТД,
	|	ТоварыОрганизаций.НомерГТД КАК НомерГТД,
	|	&КонецПериода КАК Период,
	|	ТоварыОрганизаций.КоличествоОстаток КАК КоличествоОстаток,
	|	ТоварыОрганизаций.КОформлениюСписанияОстаток КАК КОформлениюСписанияОстаток
	|ПОМЕСТИТЬ ВТОстаткиПрошлыйПериодВсе
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций.Остатки(
	|			&ГраницаКонецПредыдущегоПериода,
	|			Организация В (&МассивОрганизаций)
	|				И ВидЗапасов В
	|					(ВЫБРАТЬ
	|						ВидЗапасов.Ссылка
	|					ИЗ
	|						ВТРазрешенныеВидыЗапасов КАК ВидЗапасов)) КАК ТоварыОрганизаций
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Резервы.Организация,
	|	Резервы.АналитикаУчетаНоменклатуры,
	|	Резервы.ВидЗапасов,
	|	Резервы.АналитикаУчетаНоменклатуры.Номенклатура.ВестиУчетПоГТД,
	|	Резервы.НомерГТД,
	|	&КонецПериода КАК Период,
	|	Резервы.КоличествоОстаток,
	|	0
	|ИЗ
	|	РегистрНакопления.РезервыТоваровОрганизаций.Остатки(
	|			&ГраницаКонецПредыдущегоПериода,
	|			Организация В (&МассивОрганизаций)
	|				И ВидЗапасов В
	|					(ВЫБРАТЬ
	|						ВидЗапасов.Ссылка
	|					ИЗ
	|						ВТРазрешенныеВидыЗапасов КАК ВидЗапасов)) КАК Резервы
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВестиУчетПоГТД,
	|	НомерГТД,
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	#Удаление
	|ВЫБРАТЬ
	|	ВТОстаткиТекущийПериодВсе.Организация КАК Организация,
	|	ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ВТОстаткиТекущийПериодВсе.ВидЗапасов КАК ВидЗапасов,
	|	ВТОстаткиТекущийПериодВсе.НомерГТД КАК НомерГТД,
	|	ВТОстаткиТекущийПериодВсе.Период КАК Период,
	|	ВТОстаткиТекущийПериодВсе.КоличествоОстаток + 
	|		ВЫБОР 
	|			КОГДА ТоварыОрганизаций.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ * ЕСТЬNULL(ТоварыОрганизаций.Количество, 0) КАК КоличествоОстаток,
	|	ВТОстаткиТекущийПериодВсе.КОформлениюСписанияОстаток + 
	|		ВЫБОР 
	|			КОГДА ТоварыОрганизаций.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ * ЕСТЬNULL(ТоварыОрганизаций.КОформлениюСписания, 0) КАК КОформлениюСписанияОстаток
	|ПОМЕСТИТЬ ВТОстаткиТекущийПериод
	|ИЗ 
	|	ВТОстаткиТекущийПериодВсе КАК ВТОстаткиТекущийПериодВсе
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|		ПО &ИспользуетсяРаздельноеОформлениеЗакупок
	|			И ВТОстаткиТекущийПериодВсе.ВестиУчетПоГТД
	|			И ВТОстаткиТекущийПериодВсе.НомерГТД = ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|			И ВТОстаткиТекущийПериодВсе.Организация = ТоварыОрганизаций.Организация
	|			И ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры = ТоварыОрганизаций.АналитикаУчетаНоменклатуры
	|			И ВТОстаткиТекущийПериодВсе.ВидЗапасов = ТоварыОрганизаций.ВидЗапасов
	|			И ТоварыОрганизаций.ХозяйственнаяОперация В (&ОперацииРаздельногоОформленияЗакупок)
	|			И ТоварыОрганизаций.Период <= &КонецПериода
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	НомерГТД
	#КонецУдаления
	#Вставка
	|ВЫБРАТЬ
	|	ВТОстаткиТекущийПериодВсе.Организация КАК Организация,
	|	ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ВТОстаткиТекущийПериодВсе.ВидЗапасов КАК ВидЗапасов,
	|	ВТОстаткиТекущийПериодВсе.НомерГТД КАК НомерГТД,
	|	ВТОстаткиТекущийПериодВсе.Период КАК Период,
	|	ВТОстаткиТекущийПериодВсе.КоличествоОстаток + ЕСТЬNULL(ТоварыОрганизацийВПути.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ВТОстаткиТекущийПериодВсе.КОформлениюСписанияОстаток КАК КОформлениюСписанияОстаток
	|ПОМЕСТИТЬ ВТОстаткиТекущийПериод
	|ИЗ 
	|	ВТОстаткиТекущийПериодВсе КАК ВТОстаткиТекущийПериодВсе
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(
	|				&ГраницаКонецПериода,
	|				Организация В (&МассивОрганизаций)
	|				И ВидЗапасов В
	|					(ВЫБРАТЬ
	|						ВидЗапасов.Ссылка
	|					ИЗ
	|						ВТВидыЗапасовВПути КАК ВидЗапасов)) КАК ТоварыОрганизацийВПути
	|		ПО &ИспользуетсяРаздельноеОформлениеЗакупок
	|			И ВТОстаткиТекущийПериодВсе.ВестиУчетПоГТД
	|			И ВТОстаткиТекущийПериодВсе.НомерГТД = ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|			И ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры.Номенклатура = ТоварыОрганизацийВПути.АналитикаУчетаНоменклатуры.Номенклатура
	|			И ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры.Характеристика = ТоварыОрганизацийВПути.АналитикаУчетаНоменклатуры.Характеристика
	|			И ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры.Серия = ТоварыОрганизацийВПути.АналитикаУчетаНоменклатуры.Серия
	|			И ВТОстаткиТекущийПериодВсе.Организация = ТоварыОрганизацийВПути.Организация
	|			И ВТОстаткиТекущийПериодВсе.АналитикаУчетаНоменклатуры.МестоХранения = &СкладЗаказа
	|			И ТоварыОрганизацийВПути.КоличествоОстаток > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	НомерГТД
	#КонецВставки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТОстаткиТекущийПериодВсе
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	#Удаление
	|ВЫБРАТЬ
	|	ВТОстаткиПрошлыйПериодВсе.Организация КАК Организация,
	|	ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ВТОстаткиПрошлыйПериодВсе.ВидЗапасов КАК ВидЗапасов,
	|	ВТОстаткиПрошлыйПериодВсе.НомерГТД КАК НомерГТД,
	|	ВТОстаткиПрошлыйПериодВсе.Период КАК Период,
	|	ВТОстаткиПрошлыйПериодВсе.КоличествоОстаток + 
	|		ВЫБОР 
	|			КОГДА ТоварыОрганизаций.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ * ЕСТЬNULL(ТоварыОрганизаций.Количество, 0) КАК КоличествоОстаток,
	|	ВТОстаткиПрошлыйПериодВсе.КОформлениюСписанияОстаток + 
	|		ВЫБОР 
	|			КОГДА ТоварыОрганизаций.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ * ЕСТЬNULL(ТоварыОрганизаций.КОформлениюСписания, 0) КАК КОформлениюСписанияОстаток
	|ПОМЕСТИТЬ ВТОстаткиПрошлыйПериод
	|ИЗ 
	|	ВТОстаткиПрошлыйПериодВсе КАК ВТОстаткиПрошлыйПериодВсе
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|		ПО &ИспользуетсяРаздельноеОформлениеЗакупок
	|			И ВТОстаткиПрошлыйПериодВсе.ВестиУчетПоГТД
	|			И ВТОстаткиПрошлыйПериодВсе.НомерГТД = ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|			И ВТОстаткиПрошлыйПериодВсе.Организация = ТоварыОрганизаций.Организация
	|			И ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры = ТоварыОрганизаций.АналитикаУчетаНоменклатуры
	|			И ВТОстаткиПрошлыйПериодВсе.ВидЗапасов = ТоварыОрганизаций.ВидЗапасов
	|			И ТоварыОрганизаций.ХозяйственнаяОперация В (&ОперацииРаздельногоОформленияЗакупок)
	|			И ТоварыОрганизаций.Период <= &КонецПредыдущегоПериода
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	НомерГТД
	#КонецУдаления
	#Вставка
	|ВЫБРАТЬ
	|	ВТОстаткиПрошлыйПериодВсе.Организация КАК Организация,
	|	ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ВТОстаткиПрошлыйПериодВсе.ВидЗапасов КАК ВидЗапасов,
	|	ВТОстаткиПрошлыйПериодВсе.НомерГТД КАК НомерГТД,
	|	ВТОстаткиПрошлыйПериодВсе.Период КАК Период,
	|	ВТОстаткиПрошлыйПериодВсе.КоличествоОстаток + ЕСТЬNULL(ТоварыОрганизацийВПути.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ВТОстаткиПрошлыйПериодВсе.КОформлениюСписанияОстаток КАК КОформлениюСписанияОстаток
	|ПОМЕСТИТЬ ВТОстаткиПрошлыйПериод
	|ИЗ 
	|	ВТОстаткиПрошлыйПериодВсе КАК ВТОстаткиПрошлыйПериодВсе
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(
	|				&ГраницаКонецПредыдущегоПериода,
	|				Организация В (&МассивОрганизаций)
	|				И ВидЗапасов В
	|					(ВЫБРАТЬ
	|						ВидЗапасов.Ссылка
	|					ИЗ
	|						ВТВидыЗапасовВПути КАК ВидЗапасов)) КАК ТоварыОрганизацийВПути
	|		ПО &ИспользуетсяРаздельноеОформлениеЗакупок
	|			И ВТОстаткиПрошлыйПериодВсе.ВестиУчетПоГТД
	|			И ВТОстаткиПрошлыйПериодВсе.НомерГТД = ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|			И ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры.Номенклатура = ТоварыОрганизацийВПути.АналитикаУчетаНоменклатуры.Номенклатура
	|			И ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры.Характеристика = ТоварыОрганизацийВПути.АналитикаУчетаНоменклатуры.Характеристика
	|			И ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры.Серия = ТоварыОрганизацийВПути.АналитикаУчетаНоменклатуры.Серия
	|			И ВТОстаткиПрошлыйПериодВсе.Организация = ТоварыОрганизацийВПути.Организация
	|			И ВТОстаткиПрошлыйПериодВсе.АналитикаУчетаНоменклатуры.МестоХранения = &СкладЗаказа
	|			И ТоварыОрганизацийВПути.КоличествоОстаток > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	НомерГТД
	#КонецВставки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТОстаткиПрошлыйПериодВсе
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 10
	|	ОстаткиТекущийПериод.Организация КАК Организация,
	|	ОстаткиТекущийПериод.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ОстаткиТекущийПериод.ВидЗапасов КАК ВидЗапасов,
	|	ОстаткиТекущийПериод.НомерГТД КАК НомерГТД,
	|	ОстаткиТекущийПериод.Период КАК Период,
	|	СУММА(ОстаткиТекущийПериод.КоличествоОстаток) КАК Количество,
	|	СУММА(ОстаткиТекущийПериод.КоличествоОстаток - ЕСТЬNULL(ОстаткиПрошлыйПериод.КоличествоОстаток, 0)) КАК Оборот
	|ПОМЕСТИТЬ ОтрицательныеОстатки
	|ИЗ
	|	ВТОстаткиТекущийПериод КАК ОстаткиТекущийПериод
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПрошлыйПериод КАК ОстаткиПрошлыйПериод
	|		ПО ОстаткиТекущийПериод.Организация = ОстаткиПрошлыйПериод.Организация
	|			И ОстаткиТекущийПериод.АналитикаУчетаНоменклатуры = ОстаткиПрошлыйПериод.АналитикаУчетаНоменклатуры
	|			И ОстаткиТекущийПериод.ВидЗапасов = ОстаткиПрошлыйПериод.ВидЗапасов
	|			И ОстаткиТекущийПериод.НомерГТД = ОстаткиПрошлыйПериод.НомерГТД
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиТекущийПериод.Организация,
	|	ОстаткиТекущийПериод.АналитикаУчетаНоменклатуры,
	|	ОстаткиТекущийПериод.ВидЗапасов,
	|	ОстаткиТекущийПериод.НомерГТД,
	|	ОстаткиТекущийПериод.Период
	|
	|ИМЕЮЩИЕ
	|	СУММА(ОстаткиТекущийПериод.КоличествоОстаток) < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 10
	|	ОстаткиТекущийПериод.Организация,
	|	ОстаткиТекущийПериод.АналитикаУчетаНоменклатуры,
	|	ОстаткиТекущийПериод.ВидЗапасов,
	|	ОстаткиТекущийПериод.НомерГТД,
	|	ОстаткиТекущийПериод.Период КАК Период,
	|	СУММА(ОстаткиТекущийПериод.КОформлениюСписанияОстаток),
	|	СУММА(ОстаткиТекущийПериод.КОформлениюСписанияОстаток - ЕСТЬNULL(ОстаткиПрошлыйПериод.КОформлениюСписанияОстаток, 0))
	|ИЗ
	|	ВТОстаткиТекущийПериод КАК ОстаткиТекущийПериод
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПрошлыйПериод КАК ОстаткиПрошлыйПериод
	|		ПО ОстаткиТекущийПериод.Организация = ОстаткиПрошлыйПериод.Организация
	|			И ОстаткиТекущийПериод.АналитикаУчетаНоменклатуры = ОстаткиПрошлыйПериод.АналитикаУчетаНоменклатуры
	|			И ОстаткиТекущийПериод.ВидЗапасов = ОстаткиПрошлыйПериод.ВидЗапасов
	|			И ОстаткиТекущийПериод.НомерГТД = ОстаткиПрошлыйПериод.НомерГТД
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиТекущийПериод.Организация,
	|	ОстаткиТекущийПериод.АналитикаУчетаНоменклатуры,
	|	ОстаткиТекущийПериод.ВидЗапасов,
	|	ОстаткиТекущийПериод.НомерГТД,
	|	ОстаткиТекущийПериод.Период
	|
	|ИМЕЮЩИЕ
	|	СУММА(ОстаткиТекущийПериод.КОформлениюСписанияОстаток) < 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТРазрешенныеВидыЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТОстаткиПрошлыйПериод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТОстаткиТекущийПериод";

	Возврат ТекстЗапроса;

КонецФункции
